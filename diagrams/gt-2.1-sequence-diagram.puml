@startuml GT-2.1 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title GT-2.1: Sequence Diagram - Chỉnh sửa thông tin Gói thầu

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "Notification Service" as N
participant "Audit Service" as A

== Khởi tạo Form Chỉnh sửa ==

U -> F: Truy cập trang chi tiết gói thầu
F -> B: GET /api/tender-packages/{id}
B -> D: Query tender package data
D --> B: Tender package data
B --> F: Tender package data

F -> F: Kiểm tra quyền chỉnh sửa
F --> U: Hiển thị nút "Chỉnh sửa" (nếu có quyền)

U -> F: Nhấn "Chỉnh sửa"
F -> B: GET /api/tender-packages/{id}/edit
B -> D: Query tender package for editing
D --> B: Tender package data
B --> F: Edit form data
F --> U: Hiển thị form chỉnh sửa với thông tin hiện tại

== Chỉnh sửa Thông tin ==

U -> F: Chỉnh sửa thông tin gói thầu
F -> F: Validation real-time
F --> U: Hiển thị validation errors (nếu có)

loop Chỉnh sửa thông tin
    U -> F: Chỉnh sửa các trường
    F -> F: Validation real-time
    alt Validation lỗi
        F --> U: Hiển thị lỗi validation
    else Validation OK
        F -> F: Auto-save draft (tùy chọn)
    end
end

== Lưu Thay đổi ==

U -> F: Nhấn "Lưu thay đổi"
F -> B: PUT /api/tender-packages/{id}
note right: Gửi dữ liệu đã chỉnh sửa

B -> B: Validation server-side
B -> B: Kiểm tra thay đổi quan trọng

alt Có thay đổi quan trọng
    B -> B: Tạo cảnh báo thay đổi quan trọng
    B --> F: Warning về thay đổi quan trọng
    F --> U: Hiển thị cảnh báo và yêu cầu xác nhận
    
    U -> F: Xác nhận thay đổi quan trọng
    F -> B: PUT /api/tender-packages/{id}/confirm-important-changes
    note right: Xác nhận thay đổi quan trọng
    
    B -> D: Update tender_packages
    D --> B: Update success
    B -> D: Insert tender_package_changes
    D --> B: Change log created
    B -> N: Send notification to stakeholders
    N --> B: Notification sent
    B -> A: Log important change
    A --> B: Audit log created
    
else Không có thay đổi quan trọng
    B -> D: Update tender_packages
    D --> B: Update success
    B -> D: Insert tender_package_changes
    D --> B: Change log created
    B -> A: Log regular change
    A --> B: Audit log created
end

B --> F: Tender package updated successfully
F --> U: Hiển thị thông báo thành công
F -> F: Cập nhật giao diện
F --> U: Cập nhật UI

== Lịch sử Thay đổi ==

U -> F: Nhấn "Xem lịch sử thay đổi"
F -> B: GET /api/tender-packages/{id}/changes
B -> D: Query tender_package_changes
D --> B: Change history data
B --> F: Change history
F --> U: Hiển thị lịch sử thay đổi

== Hoàn tác Thay đổi ==

U -> F: Nhấn "Hoàn tác" (trong 24h)
F -> B: POST /api/tender-packages/{id}/rollback
note right: { change_id: number }

B -> B: Kiểm tra thời gian hoàn tác (24h)
alt Trong thời gian cho phép
    B -> D: Rollback to previous version
    D --> B: Rollback success
    B -> D: Insert rollback log
    D --> B: Rollback log created
    B --> F: Rollback successful
    F --> U: Hiển thị thông báo "Đã hoàn tác"
else Quá thời gian cho phép
    B --> F: 400 Bad Request
    F --> U: Hiển thị thông báo "Không thể hoàn tác"
end

== Xử lý Lỗi ==

alt Không có quyền chỉnh sửa
    B --> F: 403 Forbidden
    F --> U: Hiển thị thông báo "Không có quyền chỉnh sửa"
else Gói thầu không tồn tại
    B --> F: 404 Not Found
    F --> U: Hiển thị thông báo "Gói thầu không tồn tại"
else Validation lỗi
    B --> F: 400 Bad Request
    F --> U: Hiển thị lỗi validation
else Lỗi database
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo lỗi
end

@enduml
