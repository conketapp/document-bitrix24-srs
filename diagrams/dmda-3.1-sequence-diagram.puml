@startuml DMDA-3.1 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title DMDA-3.1: Sequence Diagram - Gửi Phê duyệt Dự án Lần lượt

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "Approval Service" as A
participant "Notification Service" as N
participant "Bitrix24 API" as B24

== Khởi tạo Trang Chi tiết Dự án ==

U -> F: Truy cập trang chi tiết dự án
F -> B: GET /api/projects/{id}
B -> D: Query project data
D --> B: Project data
B --> F: Project data
F --> U: Hiển thị thông tin dự án

F -> F: Kiểm tra quyền gửi phê duyệt
F --> U: Hiển thị nút "Gửi Phê duyệt" (nếu có quyền)

== Gửi Phê duyệt ==

U -> F: Nhấn "Gửi Phê duyệt"
F -> B: GET /api/projects/{id}/can-submit-approval
B -> D: Check project status và user permissions
D --> B: Approval eligibility
B --> F: Can submit approval
F --> U: Hiển thị form gửi phê duyệt

U -> F: Chọn người phê duyệt
F -> B: GET /api/projects/approvers
B -> D: Query available approvers
D --> B: Approvers list
B --> F: Approvers list
F --> U: Hiển thị dropdown người phê duyệt

U -> F: Nhập comment (tùy chọn)
F -> F: Validate form data
F --> U: Hiển thị validation errors (nếu có)

U -> F: Nhấn "Xác nhận Gửi"
F -> B: POST /api/projects/{id}/submit-for-approval
note right: { approver_id: number, comment?: string }

B -> B: Validate approval submission
B -> D: Check final validation
D --> B: Validation result

alt Không có quyền gửi phê duyệt
    B --> F: 403 Forbidden
    F --> U: Hiển thị thông báo "Không có quyền gửi phê duyệt"
else Dự án không thể gửi phê duyệt
    B --> F: 400 Bad Request - Invalid project status
    F --> U: Hiển thị thông báo "Dự án không thể gửi phê duyệt"
else Validation thành công
    B -> D: Update project status to 'pending_approval'
    D --> B: Project status updated
    B -> D: Create approval record
    D --> B: Approval record created
    B -> A: Create approval request
    A -> D: Insert approval_requests
    D --> A: Approval request created
    A --> B: Approval request created
    B -> N: Send approval notification
    N --> B: Notification sent
    B -> B24: Sync with Bitrix24
    B24 --> B: Sync completed
    B --> F: Approval submitted successfully
    F --> U: Hiển thị thông báo thành công
end

== Xem Trạng thái Phê duyệt ==

U -> F: Nhấn "Xem Trạng thái Phê duyệt"
F -> B: GET /api/projects/{id}/approval-status
B -> D: Query approval status
D --> B: Approval status data
B --> F: Approval status
F --> U: Hiển thị trạng thái phê duyệt

== Lịch sử Phê duyệt ==

U -> F: Nhấn "Xem Lịch sử Phê duyệt"
F -> B: GET /api/projects/{id}/approval-history
B -> D: Query approval history
D --> B: History data
B --> F: Approval history
F --> U: Hiển thị lịch sử phê duyệt

== Xử lý Lỗi ==

alt Dự án không tồn tại
    B --> F: 404 Not Found
    F --> U: Hiển thị thông báo "Dự án không tồn tại"
else Người phê duyệt không hợp lệ
    B --> F: 400 Bad Request - Invalid approver
    F --> U: Hiển thị thông báo "Người phê duyệt không hợp lệ"
else Lỗi database
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo lỗi
else Lỗi Bitrix24 sync
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo "Lỗi đồng bộ với Bitrix24"
end

@enduml
