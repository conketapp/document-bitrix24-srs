@startuml DMDA-2.2 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title DMDA-2.2: Sequence Diagram - Chỉnh sửa Dự án

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "Approval System" as A
participant "Notification Service" as N

== Chỉnh sửa Dự án Trực tiếp (draft/pending_approval) ==

U -> F: Chọn dự án cần chỉnh sửa
F -> B: GET /api/projects/{id}/edit
B -> D: Query project data
D --> B: Project data
B --> F: Project data for editing
F --> U: Hiển thị form chỉnh sửa

U -> F: Nhấn "Chỉnh sửa"
F -> F: Validation real-time
F --> U: Hiển thị form với tất cả thông tin

loop Chỉnh sửa thông tin
    U -> F: Chỉnh sửa thông tin
    F -> F: Validation real-time
    alt Validation lỗi
        F --> U: Hiển thị lỗi validation
    else Validation OK
        F -> F: Auto-save draft (tùy chọn)
    end
end

U -> F: Nhấn "Lưu"
F -> B: PUT /api/projects/{id}
note right: Gửi dữ liệu đã chỉnh sửa

B -> B: Validation server-side
B -> D: Update project data
D --> B: Update success
B -> D: Insert project_change_logs
D --> B: Log created
B -> D: Update project status
D --> B: Status updated
B --> F: Updated project data
F --> U: Hiển thị thông báo thành công

== Yêu cầu Chỉnh sửa (approved/in_progress) ==

U -> F: Chọn dự án đã phê duyệt
F -> B: GET /api/projects/{id}
B -> D: Query project data
D --> B: Project data
B --> F: Project data
F --> U: Hiển thị nút "Yêu cầu chỉnh sửa"

U -> F: Nhấn "Yêu cầu chỉnh sửa"
F --> U: Hiển thị form yêu cầu chỉnh sửa

U -> F: Nhập lý do chỉnh sửa
F -> F: Validation lý do
alt Lý do không hợp lệ
    F --> U: Hiển thị lỗi validation
else Lý do hợp lệ
    U -> F: Nhấn "Gửi yêu cầu"
    F -> B: POST /api/projects/{id}/edit-request
    note right: { reason: string }
    
    B -> B: Validation request
    B -> D: Insert project_edit_requests
    D --> B: Request created
    B -> D: Update project status to 'edit_requested'
    D --> B: Status updated
    B -> A: Notify approval system
    A -> N: Send notification to approver
    N --> A: Notification sent
    A --> B: Approval workflow started
    B --> F: Edit request created
    F --> U: Hiển thị thông báo "Đã gửi yêu cầu"
end

== Phê duyệt Yêu cầu Chỉnh sửa ==

A -> B: GET /api/projects/{id}/edit-requests
B -> D: Query edit requests
D --> B: Edit requests data
B --> A: Edit requests list

A -> B: PUT /api/projects/{id}/edit-requests/{request_id}/approve
note right: { approver_id: number }

B -> D: Update edit request status to 'approved'
D --> B: Request approved
B -> D: Update project status to 'draft'
D --> B: Status updated
B -> N: Send notification to requester
N --> B: Notification sent
B --> A: Request approved
A --> U: Thông báo yêu cầu được phê duyệt

== Từ chối Yêu cầu Chỉnh sửa ==

A -> B: PUT /api/projects/{id}/edit-requests/{request_id}/reject
note right: { rejection_reason: string }

B -> D: Update edit request status to 'rejected'
D --> B: Request rejected
B -> D: Insert rejection_reason
D --> B: Reason saved
B -> N: Send notification to requester
N --> B: Notification sent
B --> A: Request rejected
A --> U: Thông báo yêu cầu bị từ chối

@enduml
