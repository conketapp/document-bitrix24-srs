@startuml DMDA-2.4 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title DMDA-2.4: Sequence Diagram - Dừng Thực hiện Dự án

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "Bitrix24" as B24
participant "Notification Service" as N

== Kiểm tra Quyền và Trạng thái ==

U -> F: Chọn dự án cần dừng thực hiện
F -> B: GET /api/projects/{id}
B -> D: Query project data
D --> B: Project data
B --> F: Project data

F -> F: Kiểm tra quyền dừng dự án
F -> F: Kiểm tra trạng thái dự án

alt Trạng thái = approved/in_progress
    F --> U: Hiển thị nút "Dừng thực hiện"
else Trạng thái khác
    F --> U: Hiển thị thông báo "Không thể dừng thực hiện"
end

== Quy trình Dừng Thực hiện Dự án ==

U -> F: Nhấn "Dừng thực hiện"
F --> U: Hiển thị confirmation dialog

U -> F: Nhập lý do dừng thực hiện
F -> F: Validation lý do

alt Lý do không hợp lệ
    F --> U: Hiển thị lỗi validation
else Lý do hợp lệ
    U -> F: Xác nhận dừng thực hiện
    F -> B: PUT /api/projects/{id}/suspend
    note right: { suspend_reason: string }
    
    B -> B: Validation quyền và trạng thái
    B -> D: Update projects SET status = 'suspended'
    D --> B: Update success
    B -> D: Update projects SET suspended_at = NOW()
    D --> B: Update success
    B -> D: Update projects SET suspended_by = user_id
    D --> B: Update success
    B -> D: Update projects SET suspend_reason = reason
    D --> B: Update success
    
    B -> D: Insert project_change_logs
    note right: action_type = 'suspend', suspend_reason = reason
    D --> B: Log created
    
    B -> B24: PUT /api/deals/{bitrix24_id}
    note right: Update deal status to suspended
    B24 --> B: Update success
    
    B -> N: Send notification to stakeholders
    N --> B: Notification sent
    
    B --> F: Project suspended successfully
    F --> U: Hiển thị thông báo thành công
    F -> F: Cập nhật danh sách dự án
    F --> U: Cập nhật UI
end

== Xử lý Lỗi ==

alt Không có quyền dừng dự án
    B --> F: 403 Forbidden
    F --> U: Hiển thị thông báo "Không có quyền dừng dự án"
else Dự án chưa được phê duyệt
    B --> F: 400 Bad Request
    F --> U: Hiển thị thông báo "Dự án chưa được phê duyệt, không thể dừng thực hiện"
else Dự án đã hoàn thành
    B --> F: 400 Bad Request
    F --> U: Hiển thị thông báo "Dự án đã hoàn thành, không thể dừng thực hiện"
else Lỗi database
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo lỗi
end

== Khôi phục Dự án (Tùy chọn) ==

U -> F: Nhấn "Khôi phục dự án"
F -> B: PUT /api/projects/{id}/resume
B -> D: Update projects SET status = 'approved'
D --> B: Update success
B -> D: Update projects SET suspended_at = NULL
D --> B: Update success
B -> D: Update projects SET suspended_by = NULL
D --> B: Update success
B -> D: Update projects SET suspend_reason = NULL
D --> B: Update success
B -> D: Insert project_change_logs
note right: action_type = 'resume'
D --> B: Log created
B -> B24: PUT /api/deals/{bitrix24_id}
note right: Update deal status to approved
B24 --> B: Update success
B --> F: Project resumed
F --> U: Hiển thị thông báo "Đã khôi phục dự án"

@enduml
