@startuml GT-1.1 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title GT-1.1: Sequence Diagram - Tạo Gói thầu mới

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "Project Module" as P
participant "Bitrix24" as B24
participant "Notification Service" as N

== Khởi tạo Form ==

U -> F: Truy cập trang tạo gói thầu
F -> B: GET /api/tender-packages/create
B -> D: Query project list
D --> B: Project list
B -> P: GET /api/projects
P --> B: Available projects
B --> F: Form data with project list
F --> U: Hiển thị form tạo gói thầu

== Nhập Thông tin Cơ bản ==

U -> F: Nhập thông tin cơ bản
F -> F: Validation real-time
F --> U: Hiển thị validation errors (nếu có)

U -> F: Chọn dự án liên quan
F -> B: GET /api/projects/{id}
B -> P: Query project details
P --> B: Project details
B --> F: Project information
F --> U: Hiển thị thông tin dự án

== Tạo Gói thầu ==

U -> F: Nhấn "Tạo gói thầu"
F -> B: POST /api/tender-packages
note right: Gửi thông tin cơ bản

B -> B: Validation thông tin
B -> B: Tự động sinh mã gói thầu
B -> D: Insert tender_packages
D --> B: Tender package created
B -> D: Update project with tender reference
D --> B: Project updated

B -> B24: POST /api/deals
note right: Tạo deal trong Bitrix24
B24 --> B: Deal created

B -> N: Send notification
N --> B: Notification sent

B --> F: Tender package created successfully
F --> U: Hiển thị thông báo thành công
F -> F: Chuyển đến trang chi tiết gói thầu

== Lưu Nháp ==

U -> F: Nhấn "Lưu nháp"
F -> B: POST /api/tender-packages/draft
note right: Gửi thông tin nháp

B -> B: Validation thông tin
B -> D: Insert tender_packages (status = 'draft')
D --> B: Draft saved
B --> F: Draft saved successfully
F --> U: Hiển thị thông báo "Đã lưu nháp"

== Preview và Xác nhận ==

U -> F: Nhấn "Xem trước"
F -> B: GET /api/tender-packages/preview
B -> B: Generate preview data
B --> F: Preview information
F --> U: Hiển thị preview gói thầu

U -> F: Xác nhận thông tin
F -> B: PUT /api/tender-packages/{id}/confirm
B -> D: Update tender_packages (status = 'created')
D --> B: Tender package confirmed

B -> B24: PUT /api/deals/{id}
note right: Cập nhật deal trong Bitrix24
B24 --> B: Deal updated

B -> N: Send confirmation notification
N --> B: Notification sent

B --> F: Tender package confirmed
F --> U: Hiển thị thông báo xác nhận

== Xử lý Lỗi ==

alt Validation lỗi
    B --> F: 400 Bad Request
    F --> U: Hiển thị lỗi validation
else Dự án không tồn tại
    B --> F: 404 Not Found
    F --> U: Hiển thị thông báo "Dự án không tồn tại"
else Lỗi Bitrix24
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo "Lỗi tích hợp Bitrix24"
end

@enduml
