@startuml GT-3.1 Sequence Diagram
!theme plain
skinparam sequenceFontSize 12

title GT-3.1: Sequence Diagram - Đính kèm Tài liệu liên quan đến Gói thầu

actor User as U
participant "Frontend" as F
participant "Backend API" as B
participant "Database" as D
participant "File Storage" as FS
participant "Virus Scanner" as VS
participant "Notification Service" as N

== Khởi tạo Trang Tài liệu ==

U -> F: Truy cập trang chi tiết gói thầu
F -> B: GET /api/tender-packages/{id}/documents
B -> D: Query tender package documents
D --> B: Documents list
B --> F: Documents data
F --> U: Hiển thị khu vực tài liệu đính kèm

== Upload Tài liệu ==

U -> F: Chọn file hoặc kéo thả file
F -> F: Validation file format và size
F --> U: Hiển thị validation errors (nếu có)

U -> F: Nhấn "Tải lên"
F -> B: POST /api/tender-packages/{id}/documents/upload
note right: Multipart form data với file

B -> B: Validation file format
B -> B: Check file size limit (50MB)
B -> B: Check storage quota (1GB per tender)

alt File không hợp lệ
    B --> F: 400 Bad Request
    F --> U: Hiển thị lỗi validation
else File hợp lệ
    B -> VS: Scan file for viruses
    VS --> B: Scan result
    
    alt File có virus
        B --> F: 400 Bad Request - Virus detected
        F --> U: Hiển thị cảnh báo virus
    else File an toàn
        B -> FS: Upload file to storage
        FS --> B: File uploaded successfully
        B -> D: Insert tender_documents
        D --> B: Document created
        B -> D: Update tender_packages storage_used
        D --> B: Storage updated
        B -> N: Send upload notification
        N --> B: Notification sent
        B --> F: Document uploaded successfully
        F --> U: Hiển thị thông báo thành công
        F -> F: Cập nhật danh sách tài liệu
        F --> U: Cập nhật UI
    end
end

== Quản lý Metadata ==

U -> F: Chọn loại tài liệu
F -> B: GET /api/document-categories
B --> F: Document categories
F --> U: Hiển thị dropdown loại tài liệu

U -> F: Nhập mô tả tài liệu
F -> B: PUT /api/tender-packages/{id}/documents/{doc_id}/metadata
note right: { category: string, description: string }

B -> D: Update tender_documents metadata
D --> B: Metadata updated
B --> F: Metadata updated successfully
F --> U: Hiển thị thông báo cập nhật

== Xem trước và Tải xuống ==

U -> F: Nhấn "Xem trước"
F -> B: GET /api/tender-packages/{id}/documents/{doc_id}/preview
B -> FS: Get file content
FS --> B: File content
B --> F: File preview data
F --> U: Hiển thị preview tài liệu

U -> F: Nhấn "Tải xuống"
F -> B: GET /api/tender-packages/{id}/documents/{doc_id}/download
B -> FS: Get file for download
FS --> B: File content
B -> D: Log download action
D --> B: Download logged
B --> F: File download response
F --> U: Tải xuống file

== Tìm kiếm và Lọc ==

U -> F: Nhập từ khóa tìm kiếm
F -> B: GET /api/tender-packages/{id}/documents/search
note right: { keyword: string, category: string }

B -> D: Search documents
D --> B: Search results
B --> F: Search results
F --> U: Hiển thị kết quả tìm kiếm

== Xóa và Thay thế ==

U -> F: Nhấn "Xóa tài liệu"
F -> B: DELETE /api/tender-packages/{id}/documents/{doc_id}
B -> D: Soft delete document
D --> B: Document deleted
B -> FS: Delete file from storage
FS --> B: File deleted
B -> D: Update storage_used
D --> B: Storage updated
B --> F: Document deleted successfully
F --> U: Hiển thị thông báo xóa

U -> F: Nhấn "Thay thế tài liệu"
F -> B: POST /api/tender-packages/{id}/documents/{doc_id}/replace
note right: Multipart form data với file mới

B -> VS: Scan new file
VS --> B: Scan result
B -> FS: Replace file in storage
FS --> B: File replaced
B -> D: Update document metadata
D --> B: Document updated
B --> F: Document replaced successfully
F --> U: Hiển thị thông báo thay thế

== Bulk Operations ==

U -> F: Chọn nhiều tài liệu
F -> B: POST /api/tender-packages/{id}/documents/bulk-operations
note right: { action: string, document_ids: number[] }

B -> D: Bulk update documents
D --> B: Bulk operation completed
B --> F: Bulk operation result
F --> U: Hiển thị kết quả bulk operation

== Xử lý Lỗi ==

alt Không có quyền upload
    B --> F: 403 Forbidden
    F --> U: Hiển thị thông báo "Không có quyền"
else File quá lớn
    B --> F: 413 Payload Too Large
    F --> U: Hiển thị lỗi "File quá lớn"
else Hết dung lượng lưu trữ
    B --> F: 507 Insufficient Storage
    F --> U: Hiển thị lỗi "Hết dung lượng"
else Lỗi upload
    B --> F: 500 Internal Server Error
    F --> U: Hiển thị thông báo lỗi
end

@enduml
